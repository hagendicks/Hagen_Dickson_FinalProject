<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/">
    <meta charset="UTF-8">
    <title>Brand Dashboard - BrandConnect</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="{{ url_for('static', filename='icon.png') }}" type="image/png">
    <style>
        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        nav ul li a { cursor: pointer; }
        nav ul li a.active-tab { color: #f1c40f; border-bottom: 2px solid #e67e22; }
    </style>
</head>
<body>
    <header>
        <div class="logo"><h1>BrandConnect</h1></div>
        <button class="menu-toggle" id="menuToggle">&#9776;</button>
        <nav>
            <ul>
                <li><a onclick="showTab('overview')" class="active-tab" id="nav-overview">Dashboard</a></li>
                <li><a onclick="showTab('create')" id="nav-create">Post Campaign</a></li>
                <li><a onclick="showTab('manage')" id="nav-manage">Manage</a></li>
                <li><a onclick="showTab('profile')" id="nav-profile">Profile</a></li>
                <li><a href="{{ url_for('feed') }}">Feed</a></li>
                <li><a href="{{ url_for('search') }}">Search</a></li> 
                <li><a href="{{ url_for('messages_inbox') }}">Messages</a></li>
            </ul>
        </nav>
        <a href="{{ url_for('logout') }}" class="btn-login">Logout</a>
    </header>

    <div class="dashboard-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div style="background-color: {% if category == 'error' %}#e74c3c{% else %}#2ecc71{% endif %}; color: white; padding: 10px; margin-bottom: 20px; border-radius: 5px; text-align: center;">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <h2 id="welcome-msg">Welcome, {{ name }}!</h2>
        
        <div id="tab-overview" class="tab-content active">
            <p class="subtitle">Overview of your marketing performance.</p>
            <div class="cards-container stats-container">
                <div class="card">
                    <h3>Active Campaigns</h3>
                    <p style="font-size: 2.5rem; color: #f1c40f; margin-top: 10px;">{{ active_count }}</p>
                </div>
                <div class="card">
                    <h3>Total Applicants</h3>
                    <p style="font-size: 2.5rem; color: #3498db; margin-top: 10px;">{{ applicants|length }}</p>
                </div>
            </div>

            {% if suggestions %}
            <h3 style="margin-top: 40px; border-bottom: 2px solid #e67e22; padding-bottom: 10px; display: inline-block;">‚ú® Recommended Influencers</h3>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 40px;">
                {% for inf in suggestions %}
                <div class="card" style="flex: 1; min-width: 250px; background: #2c3e50; text-align: center;">
                    <img src="{{ inf.ProfilePic or 'https://via.placeholder.com/80' }}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 10px;">
                    <h4>{{ inf.InfluencerName }}</h4>
                    <p style="color: #f1c40f;">{{ inf.Handle }}</p>
                    <div style="margin-top: 15px;">
                        <a href="{{ url_for('public_profile', role='Influencer', id=inf.InfluencerID) }}" class="btn-login" style="padding: 5px 15px; font-size: 0.8rem;">View</a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <h3>Recent Applicants</h3>
            <table class="data-table">
                <thead><tr><th>Influencer</th><th>Campaign</th><th>Status</th><th>Action</th></tr></thead>
                <tbody>
                    {% for app in applicants %}
                    <tr id="row-{{ app.CAM_ID }}">
                        <td>
                            <a href="{{ url_for('public_profile', role='Influencer', id=app.InfluencerID) }}" style="color: #ecf0f1; font-weight: bold; text-decoration: underline;">
                                {{ app.InfluencerName }}
                            </a>
                        </td>
                        <td>{{ app.CampaignName }}</td>
                        <td id="status-{{ app.CAM_ID }}" class="status-{{ app.CampaignStatus|lower }}">{{ app.CampaignStatus }}</td>
                        <td id="actions-{{ app.CAM_ID }}">
                            {% if app.CampaignStatus == 'Pending' %}
                                <button onclick="updateStatus({{ app.CAM_ID }}, 'Approved')" style="background:none; border:none; cursor:pointer;">‚úÖ</button>
                                <button onclick="updateStatus({{ app.CAM_ID }}, 'Rejected')" style="background:none; border:none; cursor:pointer;">‚ùå</button>
                            {% elif app.CampaignStatus == 'Approved' %}
                                <a href="{{ url_for('brand_contract_route') }}" target="_blank" class="btn-login" style="padding: 5px 10px; font-size: 0.8rem; background-color: #2c3e50; border: 1px solid #2ecc71;">üìÑ Contract</a>
                            {% else %}
                                <span style="color: #bdc3c7;">Decided</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4">No applications yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="tab-create" class="tab-content">
            <h3 style="border-bottom: 1px solid #4a6781;">Create New Campaign</h3>
            <div class="card" style="margin-top: 20px; max-width: 800px; padding: 30px;">
                <form action="{{ url_for('create_campaign') }}" method="POST">
                    <div class="input-group">
                        <label>Campaign Title</label>
                        <input type="text" name="title" required placeholder="e.g., Summer Launch">
                    </div>
                    <div class="input-group">
                        <label>Industry</label>
                        <select name="industry_name" required>
                            <option value="Fashion">Fashion</option><option value="Tech">Tech</option><option value="Music">Music</option><option value="Lifestyle">Lifestyle</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="input-group"><label>Start Date</label><input type="date" name="start_date" required></div>
                        <div class="input-group"><label>End Date</label><input type="date" name="end_date" required></div>
                    </div>
                    <button type="submit" class="btn-signup">Publish Campaign</button>
                </form>
            </div>
        </div>

        <div id="tab-manage" class="tab-content">
            <h3 style="border-bottom: 1px solid #4a6781;">Manage Campaigns</h3>
            <table class="data-table" style="margin-top: 20px;">
                <thead><tr><th>Campaign</th><th>Status</th><th>Dates</th><th>Action</th></tr></thead>
                <tbody>
                    {% for c in campaigns %}
                    <tr>
                        <td>{{ c.CampaignName }}</td>
                        <td class="status-{{ c.CampaignStatus|lower }}">{{ c.CampaignStatus }}</td>
                        <td>{{ c.StartDate }} to {{ c.EndDate }}</td>
                        <td>
                            {% if c.CampaignStatus == 'Active' %}
                            <a href="{{ url_for('update_campaign_main_status', campaign_id=c.CampaignID, action='Completed') }}" class="btn-login" style="background: #e74c3c; font-size: 0.8rem; padding: 5px;">End</a>
                            {% else %}
                            <span>Closed</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4">No campaigns found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="tab-profile" class="tab-content">
            <div class="card" style="padding: 40px;">
                <div id="brand-view">
                    <div style="display: flex; gap: 30px;">
                        <div style="width: 150px; height: 150px; border-radius: 10px; overflow: hidden; background: #ecf0f1; display: flex; align-items: center; justify-content: center;">
                            {% if brand.LogoPic %}
                            <img id="disp_brand_logo" src="{{ brand.LogoPic }}" style="width: 100%; height: 100%; object-fit: contain;">
                            {% else %}
                            <span style="font-size: 2rem;">üè¢</span>
                            {% endif %}
                        </div>
                        <div>
                            <h3 id="disp_brand_name">{{ brand.Brandname }}</h3>
                            <p>Budget: GHS <span id="disp_brand_budget">{{ brand.PayPackage }}</span></p>
                            <p>Email: <span id="disp_brand_email">{{ brand.Email }}</span></p>
                            <button onclick="document.getElementById('brand-view').style.display='none';document.getElementById('brand-edit').style.display='block';" class="btn-login" style="margin-top: 10px;">Edit</button>
                        </div>
                    </div>
                </div>
                <div id="brand-edit" style="display: none;">
                    <h3 style="border-bottom: 1px solid #4a6781; margin-bottom: 15px;">Edit Details</h3>
                    <form onsubmit="saveBrandProfile(event)">
                        <div class="input-group"><label>Logo</label><input type="file" name="profile_image" id="edit_brand_logo"></div>
                        <div class="input-group"><label>Name</label><input type="text" name="name" id="edit_brand_name" value="{{ brand.Brandname }}"></div>
                        <div class="input-group"><label>Email</label><input type="email" name="email" id="edit_brand_email" value="{{ brand.Email }}"></div>
                        <div class="input-group"><label>Budget</label><input type="number" name="budget" id="edit_brand_budget" value="{{ brand.PayPackage }}"></div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn-login" style="background: #2ecc71;">Save</button>
                            <button type="button" onclick="document.getElementById('brand-edit').style.display='none';document.getElementById('brand-view').style.display='block';" class="btn-login" style="background: #7f8c8d;">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">Timeline Posts</h3>
            <div class="create-post-container">
                <form action="{{ url_for('create_post') }}" method="POST" enctype="multipart/form-data" style="width: 100%; display: flex; gap: 10px;">
                    <input type="text" name="content" class="create-input" placeholder="Update timeline..." required>
                    <input type="file" name="image" style="display: none;" id="p_file">
                    <label for="p_file" style="cursor: pointer; padding: 10px; background: #3a3b3c; border-radius: 50%;">üì∑</label>
                    <button type="submit" class="btn-login" style="padding: 5px 15px;">Post</button>
                </form>
            </div>
            {% for post in posts %}
            <div class="post-card">
                <div class="post-header">
                    <img src="{{ brand.LogoPic }}" class="avatar-small" onerror="this.style.display='none'">
                    <div><h4>{{ brand.Brandname }}</h4><span>{{ post.CreatedAt }}</span></div>
                </div>
                <div class="post-content">
                    <p>{{ post.Content }}</p>
                    {% if post.ImageURL %}<img src="{{ post.ImageURL }}" class="post-image">{% endif %}
                    <form action="{{ url_for('delete_post', post_id=post.PostID) }}" method="POST" style="text-align: right; margin-top: 10px;">
                        <button type="submit" class="btn-login" style="background: #c0392b; font-size: 0.8rem; padding: 5px;">Delete</button>
                    </form>
                </div>
            </div>
            {% else %}
            <p>No posts yet.</p>
            {% endfor %}
        </div>
    </div>

    <script src="/script.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            if (tab) showTab(tab);
        });

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav ul li a').forEach(el => el.classList.remove('active-tab'));
            
            const target = document.getElementById('tab-' + tabName);
            if(target) {
                target.classList.add('active');
                const nav = document.getElementById('nav-' + tabName);
                if(nav) nav.classList.add('active-tab');
                
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('tab', tabName);
                window.history.pushState({}, '', newUrl);
            }
        }

        function updateStatus(appId, action) {
            if(!confirm("Confirm " + action + "?")) return;
            const statusCell = document.getElementById(`status-${appId}`);
            const actionCell = document.getElementById(`actions-${appId}`);
            statusCell.innerText = "Updating...";
            
            fetch('/api/application/status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ app_id: appId, action: action })
            }).then(r => r.json()).then(data => {
                if(data.success) {
                    statusCell.innerText = data.new_status;
                    if(data.new_status === 'Approved') {
                        statusCell.className = "status-approved";
                        actionCell.innerHTML = `<a href="{{ url_for('brand_contract_route') }}" target="_blank" class="btn-login" style="padding: 5px 10px; font-size: 0.8rem; background-color: #2c3e50; border: 1px solid #2ecc71;">üìÑ Contract</a>`;
                    } else {
                        statusCell.className = "status-rejected";
                        actionCell.innerHTML = '<span>Decided</span>';
                    }
                }
            });
        }

        function saveBrandProfile(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            fetch('/api/update_profile', { method: 'POST', body: formData })
            .then(r => r.json()).then(data => {
                if(data.success) { 
                    alert("Profile updated!"); 
                    location.reload(); 
                } else { 
                    alert("Error: " + data.message); 
                }
            });
        }
    </script>
</body>
</html>
